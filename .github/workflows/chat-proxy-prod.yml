name: Chat Proxy Production Deploy

on:
  push:
    branches:
      - main
  pull_request:
    types: [closed]
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy-prod:
    if: github.event_name == 'workflow_dispatch' || github.event_name == 'push' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    env:
      HYPHA_SERVER_URL: ${{ vars.HYPHA_SERVER_URL }}
      HYPHA_WORKSPACE: ${{ vars.HYPHA_WORKSPACE || 'ri-scale' }}
      RI_SCALE_TOKEN: ${{ secrets.RI_SCALE_TOKEN }}
      HYPHA_TOKEN: ${{ secrets.RI_SCALE_TOKEN }}
      PROD_APP_ID: chat-proxy
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install hypha-rpc python-dotenv
          python -m pip install pyyaml
          git clone --depth 1 https://github.com/oeway/hypha-apps-cli ../hypha-apps-cli
          python -m pip install -r ../hypha-apps-cli/requirements.txt
          echo "HYPHA_APPS_CLI_MAIN=${GITHUB_WORKSPACE}/../hypha-apps-cli/hypha_apps_cli/__main__.py" >> $GITHUB_ENV

      - name: Deploy production app
        id: deploy_prod
        continue-on-error: true
        run: |
          python scripts/deploy_chat_proxy.py \
            --app-id "$PROD_APP_ID" \
            --non-fatal-start \
            --health-check \
            --check-request-url \
            --model gpt-5-mini

      - name: Roll back to previous commit if deploy failed
        if: steps.deploy_prod.outcome == 'failure'
        run: |
          git checkout HEAD~1 -- chat-proxy-app/app.py chat-proxy-app/manifest.yaml
          python scripts/deploy_chat_proxy.py \
            --app-id "$PROD_APP_ID" \
            --non-fatal-start \
            --health-check \
            --check-request-url \
            --model gpt-5-mini

      - name: Ensure production health
        run: |
          python scripts/test_chat_proxy.py \
            --app-id "$PROD_APP_ID" \
            --model gpt-5-mini \
            --timeout 120 \
            --check-request-url \
            --request-url "https://beta.bioimagearchive.org/search/search/fts?query=mouse%20OR%20tumor" \
            --request-attempts 5

      - name: Compute merged branch app ids
        if: github.event_name == 'pull_request'
        id: merged_ids
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          APP_ID=$(BRANCH_NAME="$BRANCH_NAME" python -c "from scripts.chat_proxy_utils import make_dev_app_id; import os; print(make_dev_app_id(os.environ['BRANCH_NAME']))")
          DUMMY_APP_ID=$(BRANCH_NAME="$BRANCH_NAME" python -c "from scripts.chat_proxy_utils import make_dev_app_id; import os; print(make_dev_app_id(os.environ['BRANCH_NAME'], prefix='chat-proxy-dev-dummy'))")
          echo "app_id=${APP_ID}" >> $GITHUB_OUTPUT
          echo "dummy_app_id=${DUMMY_APP_ID}" >> $GITHUB_OUTPUT

      - name: Cleanup merged branch dev apps
        if: github.event_name == 'pull_request'
        run: |
          python "$HYPHA_APPS_CLI_MAIN" stop-all-instances --app-id "${{ steps.merged_ids.outputs.app_id }}" || true
          python "$HYPHA_APPS_CLI_MAIN" uninstall --app-id "${{ steps.merged_ids.outputs.app_id }}" || true
          python "$HYPHA_APPS_CLI_MAIN" stop-all-instances --app-id "${{ steps.merged_ids.outputs.dummy_app_id }}" || true
          python "$HYPHA_APPS_CLI_MAIN" uninstall --app-id "${{ steps.merged_ids.outputs.dummy_app_id }}" || true

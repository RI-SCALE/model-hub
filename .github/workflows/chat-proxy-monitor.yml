name: Chat Proxy Health Monitor

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  monitor-and-notify:
    runs-on: ubuntu-latest
    env:
      HYPHA_SERVER_URL: ${{ vars.HYPHA_SERVER_URL }}
      HYPHA_WORKSPACE: ${{ vars.HYPHA_WORKSPACE || 'ri-scale' }}
      RI_SCALE_TOKEN: ${{ secrets.RI_SCALE_TOKEN }}
      HYPHA_TOKEN: ${{ secrets.RI_SCALE_TOKEN }}
      PROD_APP_ID: chat-proxy
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install hypha-rpc python-dotenv
          python -m pip install pyyaml
          git clone --depth 1 https://github.com/oeway/hypha-apps-cli ../hypha-apps-cli
          python -m pip install -r ../hypha-apps-cli/requirements.txt

      - name: Production health check
        id: health
        continue-on-error: true
        run: |
          python scripts/test_chat_proxy.py \
            --app-id "$PROD_APP_ID" \
            --model gpt-5-mini \
            --timeout 120 \
            --check-search \
            --search-query "mouse tumor" \
            --search-limit 5

      - name: Notify Slack when health check fails
        if: steps.health.outcome == 'failure' && env.SLACK_WEBHOOK_URL != ''
        run: |
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TEXT=":rotating_light: Chat Proxy health check failed for app '$PROD_APP_ID' in '${{ github.repository }}' (workflow: '${{ github.workflow }}').\nRun: $RUN_URL"
          curl -sS -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-type: application/json' \
            --data "{\"text\":\"$TEXT\"}"

      - name: Warn when Slack webhook is missing
        if: steps.health.outcome == 'failure' && env.SLACK_WEBHOOK_URL == ''
        run: |
          echo "Health check failed, but SLACK_WEBHOOK_URL is not configured."

      - name: Fail workflow when health check fails
        if: steps.health.outcome == 'failure'
        run: |
          echo "Chat Proxy production health check failed."
          exit 1

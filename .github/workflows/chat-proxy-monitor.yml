name: Chat Proxy Health Monitor

on:
  schedule:
    - cron: '*/15 * * * *'
  workflow_dispatch:

jobs:
  monitor-and-rollback:
    runs-on: ubuntu-latest
    env:
      HYPHA_SERVER_URL: ${{ secrets.HYPHA_SERVER_URL }}
      HYPHA_WORKSPACE: ${{ secrets.HYPHA_WORKSPACE }}
      HYPHA_TOKEN: ${{ secrets.HYPHA_TOKEN }}
      PROD_APP_ID: chat-proxy
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install hypha-rpc python-dotenv
          python -m pip install git+https://github.com/oeway/hypha-apps-cli

      - name: Production health check
        id: health
        continue-on-error: true
        run: |
          python scripts/test_chat_proxy.py \
            --app-id "$PROD_APP_ID" \
            --model gpt-5-mini \
            --timeout 120 \
            --check-search \
            --search-query "mouse tumor" \
            --search-limit 5

      - name: Roll back to previous commit when health fails
        if: steps.health.outcome == 'failure'
        run: |
          git checkout HEAD~1 -- chat-proxy-app/app.py chat-proxy-app/manifest.yaml
          python scripts/deploy_chat_proxy.py \
            --app-id "$PROD_APP_ID" \
            --non-fatal-start \
            --health-check \
            --model gpt-5-mini

      - name: Verify post-rollback health
        if: steps.health.outcome == 'failure'
        run: |
          python scripts/test_chat_proxy.py \
            --app-id "$PROD_APP_ID" \
            --model gpt-5-mini \
            --timeout 120 \
            --check-search \
            --search-query "mouse tumor" \
            --search-limit 5
